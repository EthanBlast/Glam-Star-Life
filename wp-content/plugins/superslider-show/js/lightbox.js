var Lightbox=new Class({Implements:[Events,Options],options:{resizeDuration:400,resizeTransition:Fx.Transitions.sineInOut,initialWidth:150,initialHeight:150,animateCaption:{In:true,Out:true},container:document.body,showControls:true,showNumbers:true,descriptions:true,opacity:0.3,onClose:$empty,onOpen:$empty},initialize:function(a){this.setOptions(a);this.options.container=document.body;this.anchors=[];$$("a[rel]").each(function(c){if(c.rel&&c.rel.test(/^lightbox/i)){c.onclick=this.click.pass(c,this);this.anchors.push(c)}},this);this.eventPosition=this.position.bind(this);this.overlay=new Element("div").set("id","lbOverlay").injectInside(this.options.container);this.center=new Element("div").set("id","lbCenter").setStyles({width:this.options.initialWidth+"px",height:this.options.initialHeight+"px",marginLeft:"-"+(this.options.initialWidth/2)+"px",display:"none"}).injectInside(this.options.container);this.image=new Element("div").set("id","lbImage").injectInside(this.center);this.bottomContainer=new Element("div").set("id","lbBottomContainer").setStyle("display","none").injectInside(this.options.container);this.bottom=new Element("div").set("id","lbBottom").injectInside(this.bottomContainer);if(this.options.showControls){this.controlDiv=new Element("div").set("id","lbControls").injectInside(this.bottom)}else{this.controlDiv=this.image}this.prevLink=new Element("a").setProperties({id:"lbPrevLink",href:"#"}).setStyle("display","none").injectInside(this.controlDiv);this.nextLink=this.prevLink.clone().set("id","lbNextLink").injectInside(this.controlDiv);this.prevLink.onclick=this.previous.bind(this);this.nextLink.onclick=this.next.bind(this);this.closeButton=new Element("a").setProperties({id:"lbCloseLink",href:"#"}).injectInside(this.bottom);this.closeButton.onclick=this.overlay.onclick=this.close.bind(this);this.caption=new Element("div").set("id","lbCaption").injectInside(this.bottom);if(this.options.descriptions!=false){this.options.descriptions=$$(this.options.descriptions);this.description=new Element("div").set("id","lbDescription").injectInside(this.bottom)}if(this.options.showNumbers){this.number=new Element("div").set("id","lbNumber").injectInside(this.bottom)}new Element("div").setStyle("clear","both").injectInside(this.bottom);var b=this.nextEffect.bind(this);this.fx={overlay:new Fx.Tween(this.overlay,"opacity",{duration:500}),resize:new Fx.Morph(this.center,{duration:this.options.resizeDuration,transition:this.options.resizeTransition,onComplete:b}),image:new Fx.Tween(this.image,"opacity",{duration:500,onComplete:b}),bottom:new Fx.Tween(this.bottom,"margin-top",{duration:400,onComplete:b})};this.overlay.fade("hide");this.preloadPrev=new Image();this.preloadNext=new Image()},click:function(d){this.options.descriptions.each(function(f,e){if(f.hasClass(d.id)){this.linkLoc=e}},this);if(d.rel.length==8){return this.show(d.href,d.title)}var c,b,a=[];this.anchors.each(function(e){if(e.rel==d.rel){for(c=0;c<a.length;c++){if(a[c][0]==e.href){break}}if(c==a.length){a.push([e.href,e.title]);if(e.href==d.href){b=c}}}},this);return this.open(a,b)},show:function(a,b){return this.open([[a,b]],0)},open:function(a,b){this.images=a;this.position();this.setup(true);this.top=window.getScrollTop()+(window.getHeight()/15);this.window={};this.window.height=window.getScrollHeight();this.window.width=window.getScrollWidth();this.window.top=window.getScrollTop();this.window.left=window.getScrollLeft();this.center.setStyles({top:this.top+"px",display:""});this.overlay.fade(this.options.opacity);this.fireEvent("onOpen");return this.changeImage(b)},position:function(){if(this.options.container==document.body){var b=window.getScrollHeight()+"px";var a=window.getScrollWidth()+"px";this.overlay.setStyles({top:"0px",height:b,width:a})}else{var c=this.options.container.getCoordinates();this.overlay.setStyles({top:c.top+"px",height:c.height+"px",left:c.left+"px",width:c.width+"px"})}},setup:function(a){var c=$A(document.getElementsByTagName("object"));if(window.ie){c.extend(document.getElementsByTagName("select"))}c.each(function(d){d.style.visibility=a?"hidden":""});var b=a?"addEvent":"removeEvent";window[b]("scroll",this.eventPosition)[b]("resize",this.eventPosition);this.step=0},previous:function(){this.linkLoc--;return this.changeImage(this.activeImage-1)},next:function(){this.linkLoc++;return this.changeImage(this.activeImage+1)},changeImage:function(a){if(this.step||(a<0)||(a>=this.images.length)){return false}this.step=1;this.activeImage=a;if(this.options.animateCaption.In&&this.bottom.offsetHeight){this.prevLink.style.display=this.nextLink.style.display="none";this.bottom.set("tween",{duration:300,onComplete:this.loadImage.bind(this)}).start(-this.bottom.offsetHeight)}else{this.bottomContainer.style.display=this.prevLink.style.display=this.nextLink.style.display="none";this.loadImage()}this.image.fade();this.center.className="lbLoading";return false},loadImage:function(){this.preload=new Image();this.preload.onload=this.nextEffect.bind(this);this.preload.src=this.images[this.activeImage][0]},nextEffect:function(){switch(this.step++){case 1:this.center.className="";this.image.style.backgroundImage="url("+this.images[this.activeImage][0]+")";this.image.style.width=this.bottom.style.width=this.preload.width+"px";if(this.options.showControls){this.image.style.height=this.preload.height+"px"}else{this.image.style.height=this.prevLink.style.height=this.nextLink.style.height=this.preload.height+"px"}this.caption.set("html",this.images[this.activeImage][1]||"");if(this.options.descriptions!=false){if(this.description.getFirst()){this.description.getFirst().remove()}var b=this.options.descriptions[this.linkLoc].clone();b.setStyle("display","block").injectInside(this.description)}if(this.options.showNumbers){this.number.set(("html",this.images.length==1)?"":"Image "+(this.activeImage+1)+" of "+this.images.length)}if(this.activeImage){this.preloadPrev.src=this.images[this.activeImage-1][0]}if(this.activeImage!=(this.images.length-1)){this.preloadNext.src=this.images[this.activeImage+1][0]}if(this.center.clientHeight!=this.image.offsetHeight){this.fx.resize.start({height:this.image.offsetHeight});break}this.step++;case 2:if(this.center.clientWidth!=this.image.offsetWidth){this.fx.resize.start({width:this.image.offsetWidth,marginLeft:-this.image.offsetWidth/2});break}this.step++;case 3:this.bottomContainer.setStyles({top:(this.top+this.center.clientHeight)+"px",height:"0px",marginLeft:this.center.style.marginLeft,display:""});this.image.fade("in");var a=this.caption.getStyle("height").toInt();if(this.options.descriptions!=false){a+=this.description.getStyle("height").toInt()}if(this.options.showControls){a+=this.controlDiv.getStyle("height").toInt()}if(this.options.showNumbers){a+=this.number.getStyle("height").toInt()}var c=(a-(this.closeButton.getStyle("height").toInt()*2));if(c<0){c=0}this.closeButton.setStyle("marginTop",c+"px");if(this.activeImage!=0){this.prevLink.style.display=""}if(this.activeImage!=(this.images.length-1)){this.nextLink.style.display=""}break;case 4:if(this.options.animateCaption.Out){this.fx.bottom.set(-this.bottom.offsetHeight);this.bottomContainer.style.height="";this.fx.bottom.start(0);break}this.bottomContainer.style.height="";case 5:this.step=0}},close:function(){if(this.step<0){return}this.step=-1;if(this.preload){this.preload.onload=Class.empty;this.preload=null}for(var a in this.fx){this.fx[a].cancel()}this.center.style.display=this.bottomContainer.style.display="none";this.overlay.fade("out");this.setup.pass(false,this);this.overlay.setStyles({height:this.window.height+"px",width:this.window.width+"px"});this.fireEvent("onClose");return false}});